# –†–∞–±–æ—Ç–∞ —Å–æ Spark

–í—Å–µ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π –±—É–¥—É—Ç –≤—ã–ª–æ–∂–µ–Ω—ã –ø–æ–¥—Ä—è–¥ –≤ –∫–æ–Ω—Ü–µ –¥–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ - [—Ç—É—Ç](#–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ-–∑–∞–¥–∞—á–∏) \
–ê –Ω–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω —Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã

## 1. –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

–ü–µ—Ä–µ–π–¥–µ–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `docker-compose/spark` –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª [.env](./docker-compose/spark/.env), —É–∫–∞–∑–∞–≤ –≤–º–µ—Å—Ç–æ **HOSTNAME** –∏–º—è —Å–≤–æ–µ–π –º–∞—à–∏–Ω—ã (—É –º–µ–Ω—è –Ω–∞ –ª–∏–Ω—É–∫—Å–µ –∫–æ–º–∞–Ω–¥–∞ `hostname` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ainkubePC, –ø–æ—ç—Ç–æ–º—É —è –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ. –ê –Ω–∞ –º–∞–∫–µ –Ω—É–∂–Ω–æ –±—ã–ª–æ –±—ã –ø—Ä–æ–ø–∏—Å–∞—Ç—å ainkubePC.local).

–¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏–º –∫–æ–º–∞–Ω–¥—É:

```
docker compose up -d
```

–í –∏—Ç–æ–≥–µ —É –Ω–∞—Å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:
- spark –º–∞—Å—Ç–µ—Ä –∏ –≤–æ—Ä–∫–µ—Ä
- –∫–∞—Ñ–∫–∞ –∏ zookeeper –¥–ª—è –Ω–µ—ë
- clickhouse

–ü—Ä–∏ —ç—Ç–æ–º –≤ clickhouse —É–∂–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å—Ö–µ–º—ã, —Ç–∞–±–ª–∏—Ü—ã, —Ç.–∫. —Ñ–∞–π–ª [init.sql](./docker-compose/spark/clickhouse_conf/init.sql) –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ `/docker-entrypoint-initdb.d` –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∫–ª–∏–∫—Ö–∞—É—Å–∞.

## 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∫–∞—Ñ–∫—É

–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –¥–≤–µ –ø–∞–ø–∫–∏ –Ω–∞–∑–∞–¥ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ `Streams/`. –¢–∞–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª [credentials_example.json](./Streams/credentials_example.json), –¥–æ–±–∞–≤–ª—è—è –≤ –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞ `ch` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è —Ö–æ—Å—Ç–∞, –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å –æ—Ç –±–æ–µ–≤–æ–≥–æ –∫–ª–∏–∫–∞ (–æ—Ç—Ç—É–¥–∞ –±—É–¥–µ–º –±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∫–∞—Ñ–∫—É). –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ **credentials.json**.

–ü–æ–¥–∫–ª—é—á–∏–≤—à–∏—Å—å —Å –ø–æ–º–æ—â—å—é Offset Explorer –∫ –∫–∞—Ñ–∫–µ (–ø–æ –∞–¥—Ä–µ—Å—É `127.0.0.1:9093`) —Å–æ–∑–¥–∞–¥–∏–º —Ç–æ–ø–∏–∫ `shkCreate`.

–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ø—Ä–æ—à–ª—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ `kafka-scripts/`. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã:

```
$ python3 -m venv venv
$ source venv/bin/activate
(venv) $ pip install -r requirements.txt
```

–ó–∞–ø—É—Å–∫–∞–µ–º [ch_producer.py](./kafka-scripts/ch_producer.py):

```
python3 ch_producer.py
```

–í kafka –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è:

![shkCreate topic](./img/kafka.png)

## 3. –î–æ–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º clickhouse

–í –∑–∞–¥–∞–Ω–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–æ–≥–∞—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ—Ç —á–∏—Ç–∞—Ç—å **spark** –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–æ–π. \
–î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –∑–∞–π—Ç–∏ –Ω–∞ –±–æ–µ–≤–æ–π –∫–ª–∏–∫ –∏ –≤–∑—è—Ç—å –æ—Ç—Ç—É–¥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ª–æ–≤–∞—Ä—å, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤ csv –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–ª–∏–∫–µ (–≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –≤ —Å–æ–∑–¥–∞–Ω–Ω—É—é —Å –ø–æ–º–æ—â—å—é [init.sql](./docker-compose/spark/clickhouse_conf/init.sql) —Ç–∞–±–ª–∏—Ü—É `volume_by_nm`)

## 4. –ó–∞–ø—É—Å–∫–∞–µ–º Spark application

–ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –º–æ–∂–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ spark. –î–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–π–¥—ë–º –ø–æ –∞–¥—Ä–µ—Å—É http://YOUR_HOSTNAME:8080, –≥–¥–µ YOUR_HOSTNAME - –∏–º—è, –∫–æ—Ç–æ—Ä–æ–µ –º—ã —É–∫–∞–∑–∞–ª–∏ –≤ [.env](./docker-compose/spark/.env). –ï—Å–ª–∏ –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –º—ã —É–≤–∏–¥–∏–º —Å–ª–µ–¥—É—é—â–µ–µ:

![Spark master](./img/spark_master.png)

–ó–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ–º [shkCreate_sync_edu.py](./Streams/shkCreate_edu_100/shkCreate_sync_edu.py):

```
docker exec --user root -it spark-master /bin/bash
pip install clickhouse_driver clickhouse_cityhash lz4 pandas
spark-submit --master spark://spark-master:7077  \
    --packages org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.0 \
    --executor-cores 1 \
    --conf spark.driver.extraJavaOptions="-Divy.cache.dir=/tmp -Divy.home=/tmp" \
    /opt/spark/Streams/shkCreate_edu_100/shkCreate_sync_edu.py
```

–ö–∞–∫ –∏—Ç–æ–≥, –≤–∏–¥–∏–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ `shkCreate_edu_7` –∑–∞–ø—É—â–µ–Ω–æ:

![running_spark_app](./img/running_spark_app.png)

–ò –ø–æ—è–≤–∏–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ `stage.raw_shkCreate_edu_7`:

![raw_shkCreate_edu_7](./img/raw_shkCreate_edu_7.png)

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

1. –°—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–π –ö–∞—Ñ–∫–∏ —á–µ—Ä–µ–∑ —Å–ø–∞—Ä–∫ - [shkCreate_sync_edu.py](./Streams/shkCreate_edu_100/shkCreate_sync_edu.py)
2. –î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫—É—é-–Ω–∏–±—É–¥—å –∫–æ–ª–æ–Ω–∫—É. –ó–∞–ø–∏—Å–∞—Ç—å –≤ –≤–∞—à –∫–ª–∏–∫ –≤ –¥–æ–∫–µ—Ä–µ - [shkCreate_sync_edu.py](./Streams/shkCreate_edu_100/shkCreate_sync_edu.py)
3. –í—ã–ª–æ–∂–∏—Ç—å –ø–∞–ø–∫—É —Å docker-compose —Ñ–∞–π–ª–∞–º–∏ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 2 —Ñ–∞–π–ª–∞: docker-compose.yml, .env - [–ø–∞–ø–∫–∞](./docker-compose/spark/)
4. –ó–∞–ø—É—à–∏—Ç—å –≤ —Å–≤–æ–π –≥–∏—Ç –ø–æ–ª—É—á–∏–≤—à–∏–π—Å—è —Ç–∞—Å–∫ —Å–ø–∞—Ä–∫ - [shkCreate_sync_edu.py](./Streams/shkCreate_edu_100/shkCreate_sync_edu.py)
5. –í—ã–ª–æ–∂–∏—Ç—å –≤ –≥–∏—Ç —Å–∫—Ä–∏–Ω—ã —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –∫–æ–Ω–µ—á–Ω–æ–π –ø–∞–ø–∫–∏ –≤ –≤–∞—à–µ–º –∫–ª–∏–∫–µ:

![raw_shkCreate_edu_7_content](./img/raw_shkCreate_edu_7_content.png)

![raw_shkCreate_edu_7](./img/raw_shkCreate_edu_7.png)

6. –í—ã–ª–æ–∂–∏—Ç—å –∫–æ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω–µ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤ –≤–∞—à–µ–º –∫–ª–∏–∫–µ - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å 9 —Å—Ç—Ä–æ—á–∫–∏ –≤ —Ñ–∞–π–ª–µ [init.sql](./docker-compose/spark/clickhouse_conf/init.sql)
7. –í—ã–ª–æ–∂–∏—Ç—å —Å–∫—Ä–∏–Ω –≤–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤–∞—à–µ–≥–æ —Å–ø–∞—Ä–∫:

![running_spark_app](./img/running_spark_app.png)

8. –°–∫—Ä–∏–Ω —Ä–∞–±–æ—Ç—ã –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - —Å–∫—Ä–∏–Ω—à–æ—Ç –≤—ã—à–µ üëÜ